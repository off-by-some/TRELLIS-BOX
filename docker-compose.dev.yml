version: '3.8'

services:
  trellis:
    # Use same GPU config as working docker-compose.yml
    environment:
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-all}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: ${GPU_COUNT:-all}
              capabilities: [gpu]
    ports:
      # Explicitly bind to all interfaces for remote access
      - "0.0.0.0:${HOST_PORT:-8501}:${APP_PORT:-8501}"
    volumes:
      # Mount only essential files to avoid GPU conflicts
      # Critical for hot reloading: app.py and webui/
      - ./app.py:/app/app.py:z
      - ./webui:/app/webui:z
      # Skip docs/ and assets/ - not essential for development
      # NOT mounted: trellis/ (installed package - rebuild for changes)
      # NOT mounted: extensions/ (compiled C++ code)
    environment:
      # Enable hot reloading and better development experience
      - STREAMLIT_SERVER_HEADLESS=false
      # Explicitly bind Streamlit to all interfaces
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    stdin_open: true
    tty: true
    networks:
      - default
